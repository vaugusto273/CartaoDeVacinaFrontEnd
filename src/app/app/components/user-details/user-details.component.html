<div *ngIf="loading" class="loading">
    Loading...
</div>

<div *ngIf="!loading && errorMessage" class="error">
    {{ errorMessage }}
</div>

<div *ngIf="!loading && users.length > 0" class="user page">

    <!-- CARD DO USUÁRIO -->
    <div class="user-info-card">
        <div class="user-info-header">
            <span class="section-title">Vaccination Card</span>
        </div>

        <div class="user-info-body">
            <div class="user-info-row">

                <!-- SELECT DE USUÁRIO -->
                <div class="info-field">
                    <span class="label">User:</span>
                    <select [ngModel]="selectedUserId" (ngModelChange)="onUserChange($event)" class="user-select">
                        <option *ngFor="let u of users" [ngValue]="u.id">
                            {{ u.name }}
                        </option>
                    </select>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">ID:</span>
                    <span class="value">{{ user.id }}</span>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">Age:</span>
                    <span class="value">{{ user.age }}</span>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">Gender:</span>
                    <span class="value">{{ user.gender }}</span>
                </div>

            </div>
        </div>
    </div>

    <!-- ABAS VISUAIS -->
    <div class="tabs-container">
        <button class="tab active">National Vaccination Card</button>
        <button class="tab">Anti Rabies</button>
        <button class="tab">Contact BCG</button>
        <button class="tab">Private Vaccines</button>
        <button class="tab">Other Vaccines</button>
    </div>

    <!-- CARTÃO EM GRADE -->
    <!-- CARTÃO EM GRADE -->
    <div class="vaccine-card">

        <div class="vaccine-grid-wrapper">

            <div *ngIf="vaccineColumns.length === 0" class="no-records">
                No vaccination records for this user.
            </div>

            <div *ngIf="vaccineColumns.length > 0" class="vaccine-grid">

                <!-- LINHA DE CABEÇALHO: "Vaccines/Doses" + nomes das vacinas -->
                <div class="grid-row header-row">
                    <div class="sidebar-header">
                        Vaccines<br>Doses
                    </div>

                    <div class="vaccine-grid-header" *ngFor="let vaccine of vaccineColumns">
                        {{ vaccine.vaccineName }}
                    </div>
                </div>

                <!-- UMA LINHA POR DOSE -->
                <div class="grid-row" *ngFor="let d of doseLevels">
                    <!-- coluna da dose -->
                    <div class="dose-row">
                        {{ doseLabel(d) }}
                    </div>

                    <!-- células das vacinas para essa dose -->
                    <div class="vaccine-grid-cell" *ngFor="let vaccine of vaccineColumns" [ngClass]="{
              'taken': getRecordFor(vaccine.id, d),
              'missing': !getRecordFor(vaccine.id, d)
            }">
                        <ng-container *ngIf="getRecordFor(vaccine.id, d) as rec">
                            <div class="cell-notes">
                                {{ rec.notes || '' }}
                            </div>
                            <div class="cell-date">
                                {{ formatDate(rec.applicationDate) }}
                            </div>
                        </ng-container>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- SEÇÃO: ADICIONAR NOVO USUÁRIO -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Add New User</span>
            </div>
            <div class="user-info-body">
                <form (ngSubmit)="addUser()" #userForm="ngForm" class="form">
                    <div class="user-info-row">

                        <div class="info-field">
                            <span class="label">Name:</span>
                            <input type="text" name="newUserName" [(ngModel)]="newUserName" required />
                        </div>

                        <div class="info-field small">
                            <span class="label">Age:</span>
                            <input type="number" name="newUserAge" [(ngModel)]="newUserAge" />
                        </div>

                        <div class="info-field small">
                            <span class="label">Gender:</span>
                            <select name="newUserGender" [(ngModel)]="newUserGender">
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <div class="info-field">
                            <button type="submit" [disabled]="!userForm.form.valid">
                                Add User
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SEÇÃO: ADICIONAR NOVA VACINA -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Add New Vaccine</span>
            </div>
            <div class="user-info-body">
                <form (ngSubmit)="addVaccine()" #vaccineForm="ngForm" class="form">
                    <div class="user-info-row">

                        <div class="info-field">
                            <span class="label">Name:</span>
                            <input type="text" name="newVaccineName" [(ngModel)]="newVaccineName" required />
                        </div>

                        <div class="info-field">
                            <button type="submit" [disabled]="!vaccineForm.form.valid">
                                Add Vaccine
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- SEÇÃO: ADICIONAR REGISTRO DE VACINAÇÃO -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Add Vaccination Record</span>
            </div>
            <div class="user-info-body">
                <form (ngSubmit)="addRecord()" #recordForm="ngForm" class="new-user-form">
                    <div class="user-info-row">

                        <!-- usuário vem do select principal (selectedUserId) -->
                        <div class="info-field small">
                            <span class="label">User:</span>
                            <select name="newRecordUserId" [(ngModel)]="newRecordUserId" required>
                                <option [ngValue]="undefined">Select...</option>
                                <option *ngFor="let u of users" [ngValue]="u.id">
                                    {{ u.name }}
                                </option>
                            </select>
                            <span class="value" *ngIf="!user">Select above</span>
                        </div>

                        <!-- vacina -->
                        <div class="info-field">
                            <span class="label">Vaccine:</span>
                            <select name="newRecordVaccineId" [(ngModel)]="newRecordVaccineId" required>
                                <option [ngValue]="null">Select...</option>
                                <option *ngFor="let v of vaccines" [ngValue]="v.id">
                                    {{ v.vaccineName }}
                                </option>
                            </select>
                        </div>

                        <!-- dose -->
                        <div class="info-field small">
                            <span class="label">Dose:</span>
                            <input type="number" name="newRecordDoseNumber" [(ngModel)]="newRecordDoseNumber" min="1"
                                required />
                        </div>

                        <!-- data -->
                        <div class="info-field">
                            <span class="label">Date:</span>
                            <input type="date" name="newRecordDate" [(ngModel)]="newRecordDate" required />
                        </div>

                        <!-- notas -->
                        <div class="info-field" style="flex: 1;">
                            <span class="label">Notes:</span>
                            <input type="text" name="newRecordNotes" [(ngModel)]="newRecordNotes"
                                placeholder="Optional" />
                        </div>

                        <div class="info-field">
                            <button type="submit" [disabled]="!recordForm.form.valid || !selectedUserId">
                                Add Record
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- SEÇÃO: DELETE USER -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Delete User</span>
            </div>

            <div class="user-info-body">
                <div class="user-info-row">

                    <!-- SELECT DO USUÁRIO A DELETAR -->
                    <div class="info-field small">
                        <span class="label">User:</span>
                        <select name="deleteUserId" [(ngModel)]="deleteUserId" required>
                            <option [ngValue]="undefined">Select...</option>
                            <option *ngFor="let u of users" [ngValue]="u.id">
                                {{ u.name }}
                            </option>
                        </select>
                    </div>

                    <!-- BOTÃO DELETAR -->
                    <div class="info-field">
                        <button type="button" (click)="deleteUser()" [disabled]="!deleteUserId" style="
              padding: 4px 10px;
              background-color: #d9534f;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            ">
                            Delete User
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- SEÇÃO: DELETE VACCINATION RECORD -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Delete Vaccination Record</span>
            </div>

            <div class="user-info-body">
                <div class="user-info-row">

                    <!-- Usuário atual (do cartão) -->
                    <div class="info-field small">
                        <span class="label">User:</span>
                        <span class="value" *ngIf="user; else noUser">
                            {{ user.name }} (ID: {{ user.id }})
                        </span>
                        <ng-template #noUser>
                            <span class="value">Select a user above</span>
                        </ng-template>
                    </div>

                    <!-- Select de registro -->
                    <div class="info-field" style="flex: 1;">
                        <span class="label">Record:</span>
                        <select name="deleteRecordId" [(ngModel)]="deleteRecordId"
                            [disabled]="!user || records.length === 0">
                            <option [ngValue]="undefined">Select...</option>
                            <option *ngFor="let r of records" [ngValue]="r.id">
                                {{ getVaccineName(r.vaccineID) }}
                                - Dose {{ r.doseNumber }}
                                - {{ formatDate(r.applicationDate) }}
                            </option>

                        </select>
                    </div>

                    <!-- Botão deletar -->
                    <div class="info-field">
                        <button type="button" (click)="deleteRecord()" [disabled]="!user || !deleteRecordId" style="
              padding: 4px 10px;
              background-color: #d9534f;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            ">
                            Delete Record
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>


</div>