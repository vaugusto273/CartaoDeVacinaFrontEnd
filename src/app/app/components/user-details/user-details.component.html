<div *ngIf="loading" class="loading">
    Loading...
</div>

<div *ngIf="!loading && errorMessage" class="error">
    {{ errorMessage }}
</div>

<div *ngIf="!loading && users.length > 0" class="user page">

    <!-- CARD DO USUÁRIO -->
    <div class="user-info-card">
        <div class="user-info-header">
            <span class="section-title">Vaccination Card</span>
        </div>

        <div class="user-info-body">
            <div class="user-info-row">

                <!-- SELECT DE USUÁRIO -->
                <div class="info-field">
                    <span class="label">User:</span>
                    <select [ngModel]="selectedUserId" (ngModelChange)="onUserChange($event)" class="user-select">
                        <option *ngFor="let u of users" [ngValue]="u.id">
                            {{ u.name }}
                        </option>
                    </select>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">ID:</span>
                    <span class="value">{{ user.id }}</span>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">Age:</span>
                    <span class="value">{{ user.age }}</span>
                </div>

                <div class="info-field small" *ngIf="user">
                    <span class="label">Gender:</span>
                    <span class="value">{{ user.gender }}</span>
                </div>

            </div>
        </div>
    </div>

    <!-- ABAS VISUAIS -->
    <div class="tabs-container">
        <button class="tab active">National Vaccination Card</button>
        <button class="tab">Anti Rabies</button>
        <button class="tab">Contact BCG</button>
        <button class="tab">Private Vaccines</button>
        <button class="tab">Other Vaccines</button>
    </div>

    <!-- CARTÃO EM GRADE -->
    <!-- CARTÃO EM GRADE -->
    <div class="vaccine-card">

        <div class="vaccine-grid-wrapper">

            <div *ngIf="vaccineColumns.length === 0" class="no-records">
                No vaccination records for this user.
            </div>

            <div *ngIf="vaccineColumns.length > 0" class="vaccine-grid">

                <!-- LINHA DE CABEÇALHO: "Vaccines/Doses" + nomes das vacinas -->
                <div class="grid-row header-row">
                    <div class="sidebar-header">
                        Vaccines<br>Doses
                    </div>

                    <div class="vaccine-grid-header" *ngFor="let vaccine of vaccineColumns">
                        {{ vaccine.vaccineName }}
                    </div>
                </div>

                <!-- UMA LINHA POR DOSE -->
                <div class="grid-row" *ngFor="let d of doseLevels">
                    <!-- coluna da dose -->
                    <div class="dose-row">
                        {{ doseLabel(d) }}
                    </div>

                    <!-- células das vacinas para essa dose -->
                    <div class="vaccine-grid-cell" *ngFor="let vaccine of vaccineColumns" [ngClass]="{
              'taken': getRecordFor(vaccine.id, d),
              'missing': !getRecordFor(vaccine.id, d)
            }">
                        <ng-container *ngIf="getRecordFor(vaccine.id, d) as rec">
                            <div class="cell-notes">
                                {{ rec.notes || '' }}
                            </div>
                            <div class="cell-date">
                                {{ formatDate(rec.applicationDate) }}
                            </div>
                        </ng-container>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- SEÇÃO: ADICIONAR NOVO USUÁRIO -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Add New User</span>
            </div>
            <div class="user-info-body">
                <form (ngSubmit)="addUser()" #userForm="ngForm" class="form">
                    <div class="user-info-row">

                        <div class="info-field">
                            <span class="label">Name:</span>
                            <input type="text" name="newUserName" [(ngModel)]="newUserName" required />
                        </div>

                        <div class="info-field small">
                            <span class="label">Age:</span>
                            <input type="number" name="newUserAge" [(ngModel)]="newUserAge" />
                        </div>

                        <div class="info-field small">
                            <span class="label">Gender:</span>
                            <select name="newUserGender" [(ngModel)]="newUserGender">
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <div class="info-field">
                            <button type="submit" [disabled]="!userForm.form.valid">
                                Add User
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SEÇÃO: ADICIONAR NOVA VACINA -->
    <div class="page" style="padding-top: 0;">
        <div class="user-info-card" style="margin-top: 8px;">
            <div class="user-info-header">
                <span class="section-title">Add New Vaccine</span>
            </div>
            <div class="user-info-body">
                <form (ngSubmit)="addVaccine()" #vaccineForm="ngForm" class="form">
                    <div class="user-info-row">

                        <div class="info-field">
                            <span class="label">Name:</span>
                            <input type="text" name="newVaccineName" [(ngModel)]="newVaccineName" required />
                        </div>

                        <div class="info-field">
                            <button type="submit" [disabled]="!vaccineForm.form.valid">
                                Add Vaccine
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>


</div>